{# videopost/templates/videopost/videopost_detail.html #}

{% extends 'base.html' %}
{% load time_filters %}
{% block title %}{{ videopost.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{{ videopost.title|default:"(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)" }}</h2>
  <p>–ê–≤—Ç–æ—Ä:
    <a href="{% url 'profile' username=videopost.author.username %}">
      {{ videopost.author.username|capfirst }}
    </a>
  </p>

  <p><strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> {{ videopost.publication_date|date:"d M Y H:i" }}</p>
  <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ videopost.created_at|ru_timesince }}</p>

  <!-- –í–∏–¥–µ–æ-–ø–ª–µ–µ—Ä: –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ YouTube iframe -->
  {% if videopost.video_url and 'youtube' in videopost.video_url %}
    <div class="ratio ratio-16x9 my-3">
      <iframe class="w-100"
              src="https://www.youtube.com/embed/{{ videopost.video_url|cut:'https://youtu.be/'|cut:'https://www.youtube.com/watch?v=' }}"
              frameborder="0"
              allowfullscreen></iframe>
    </div>
  {% elif videopost.video %}
    <div class="ratio ratio-16x9 my-3">
      <video controls class="w-100 rounded" preload="metadata">
        <source src="{{ videopost.video.url }}" type="video/mp4">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
      </video>
    </div>
  {% endif %}

  <!-- –ü—Ä–µ–≤—å—é —Å –∫–ª–∏–∫–æ–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
  {% if videopost.thumbnail %}
    <img src="{{ videopost.thumbnail.url }}" alt="–ü—Ä–µ–≤—å—é –≤–∏–¥–µ–æ" class="img-fluid my-3" style="cursor:pointer;" onclick="openVideoModal('{{ videopost.video.url }}')" />
    <p>URL –ø—Ä–µ–≤—å—é: {{ videopost.thumbnail.url }}</p>
  {% else %}
    <p>–ü—Ä–µ–≤—å—é –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>
  {% endif %}

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ -->
  <p>{{ videopost.description|linebreaks }}</p>

  <hr>

  <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ -->
  <div class="d-flex gap-4 align-items-center mb-3">
    <button class="btn btn-outline-primary like-btn" data-slug="{{ videopost.slug }}">
      üëç <span class="like-count">{{ videopost.likes.count }}</span>
    </button>
    <button class="btn btn-outline-danger dislike-btn" data-slug="{{ videopost.slug }}">
      üëé <span class="dislike-count">{{ videopost.dislikes.count }}</span>
    </button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  {% if user == videopost.author %}
    <div class="d-flex gap-2 mt-3">
      <a href="{% url 'videopost:videopost_update' videopost.slug %}" class="btn btn-sm btn-warning">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <button class="btn btn-sm btn-danger" onclick="confirmDelete('{{ videopost.slug }}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  {% endif %}

  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ -->
  <div class="comments-section mt-5">
    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

    {% for comment in comments %}
      <div class="comment mb-3 p-3 border rounded">
        <strong>{{ comment.author.username|capfirst }}</strong> ‚Ä¢ <small class="text-muted">{{ comment.created_at|ru_timesince }}</small>
        <p>{{ comment.text }}</p>

        <!-- –û—Ç–≤–µ—Ç—ã -->
        <div class="replies ms-4">
          {% for reply in comment.replies.all %}
            <div class="reply mb-2 p-2 border rounded">
              <strong>{{ reply.author.username|capfirst }}</strong> ‚Ä¢ <small class="text-muted">{{ reply.created_at|ru_timesince }}</small>
              <p>{{ reply.text }}</p>
            </div>
          {% endfor %}
        </div>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'videopost:reply_comment' comment.id %}">
            {% csrf_token %}
            <input type="text" name="text" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..." class="form-control mt-2" required>
            <button type="submit" class="btn btn-sm btn-secondary mt-1">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          </form>
        {% endif %}
      </div>
    {% empty %}
      <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endfor %}
  </div>

  <h4>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</h4>
  {% if user.is_authenticated %}
    {% if user.is_banned %}
      <h2><strong>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–±–∞–Ω–µ–Ω!</strong></h2>
      <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.user.ban_reason }}</p>
      <p><strong>–°—Ä–æ–∫:</strong> {{ request.user.banned_until }}</p>
    {% else %}

      <div class="comment-box p-3">
        <form method="post" class="d-flex flex-column gap-2">
          {% csrf_token %}
          <input type="hidden" name="post_id" value="{{ videopost.id }}">  <!-- –ó–¥–µ—Å—å —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ -->
          <textarea name="text" class="form-control comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3" required></textarea>
          <div class="d-flex gap-2">
              <button type="submit" class="btn btn-action flex-grow-1">–î–æ–±–∞–≤–∏—Ç—å</button>
              <a href="{% url 'videopost:videopost_list' %}" class="btn btn-action flex-grow-1">–ù–∞–∑–∞–¥</a>
    </div>
</form>

      </div>
    {% endif %}
  {% else %}
    <p class="text-danger">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    <a href="{% url 'videopost:list' %}" class="btn btn-action mt-3">–ù–∞–∑–∞–¥</a>
  {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="videoModalLabel">{{ videopost.title|default:"–í–∏–¥–µ–æ" }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <video id="modalVideo" controls class="w-100" preload="metadata">
          <source src="" type="video/mp4" />
          –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
        </video>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bootstrap JS (–µ—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –≤ base.html) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –≤–∏–¥–µ–æ
  function openVideoModal(videoUrl) {
    const video = document.getElementById('modalVideo');
    const source = video.querySelector('source');

    source.src = videoUrl;
    video.load();

    const modal = new bootstrap.Modal(document.getElementById('videoModal'));
    modal.show();

    const modalEl = document.getElementById('videoModal');
    modalEl.addEventListener('hidden.bs.modal', () => {
      video.pause();
      video.currentTime = 0;
    }, { once: true });
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  async function confirmDelete(slug) {
    const isConfirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–µ–æ–ø–æ—Å—Ç?");
    if (!isConfirmed) return;

    try {
      const response = await fetch(`/videopost/${slug}/archive/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await response.json();
      console.log("‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

      if (data.success) {
        alert("‚úÖ –í–∏–¥–µ–æ–ø–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!");
        window.location.href = "/videopost/";
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞.");
      }
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞.");
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
  function getCSRFToken() {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
      const trimmed = cookie.trim();
      if (trimmed.startsWith("csrftoken=")) {
        cookieValue = decodeURIComponent(trimmed.split("=")[1]);
      }
    });
    return cookieValue;
  }

  // –ü—Ä–∏–º–µ—Ä AJAX –¥–ª—è –ª–∞–π–∫–æ–≤ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const slug = button.getAttribute('data-slug');
      const action = button.classList.contains('like-btn') ? 'like' : 'dislike';

      try {
        const response = await fetch(`/videopost/${slug}/${action}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        const data = await response.json();

        if (data.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤
          const container = button.parentElement;
          container.querySelector('.like-count').textContent = data.likes_count;
          container.querySelector('.dislike-count').textContent = data.dislikes_count;
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    });
  });
</script>
{% endblock %}
