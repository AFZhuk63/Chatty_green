{# videopost/templates/videopost/videopost_detail.html #}

{% extends 'base.html' %}
{% load time_filters %}
{% block title %}{{ videopost.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{{ videopost.title|default:"(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)" }}</h2>
  <!-- <p>–ê–≤—Ç–æ—Ä:
    <a href="{% url 'profile' username=videopost.author.username %}">
      {{ videopost.author.username|capfirst }}
    </a>
  </p>

  <p><strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> {{ videopost.publication_date|date:"d M Y H:i" }}</p>-->
  <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ videopost.created_at|ru_timesince }}</p>

  <!-- –í–∏–¥–µ–æ-–ø–ª–µ–µ—Ä: –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ YouTube iframe -->
  {% if videopost.video_url and 'youtube' in videopost.video_url %}
    <div class="ratio ratio-16x9 my-3">
      <iframe class="w-100"
              src="https://www.youtube.com/embed/{{ videopost.video_url|cut:'https://youtu.be/'|cut:'https://www.youtube.com/watch?v=' }}"
              frameborder="0"
              allowfullscreen></iframe>
    </div>
  {% elif videopost.video %}
    <div class="ratio ratio-16x9 my-3">
      <video controls class="w-100 rounded" preload="metadata">
        <source src="{{ videopost.video.url }}" type="video/mp4">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
      </video>
    </div>
  {% endif %}

<!-- –ü—Ä–µ–≤—å—é –≤–∏–¥–µ–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –ø–ª–µ–µ—Ä–æ–º  -->

  {% if videopost.video_url %}
    <video id="my-video" class="video-js vjs-default-skin vjs-big-play-centered"
       controls preload="auto" width="100%" height="500"
       data-setup='{
         "techOrder": ["html5", "youtube"],
         "sources": [{ "type": "video/youtube", "src": "https://www.youtube.com/watch?v=Pi8KdmVbcFE" }],
         "playbackRates": [0.5, 1, 1.25, 1.5, 2]
       }'>
</video>
  {% endif %}
 <p>
<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">

  <!-- –ê–≤—Ç–æ—Ä –∏ –ø–æ–¥–ø–∏—Å–∫–∞ -->
  <div class="d-flex align-items-center gap-2">
    <p class="author-text mb-0">
      –ê–≤—Ç–æ—Ä:
      <a href="{% url 'profile' username=videopost.author.username %}">
        {{ videopost.author.username|capfirst }}
      </a>
    </p>
    <!-- <button class="btn btn-sm btn-outline-primary like-btn" style="width: 150px;">üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button -->>

    {# –§–æ—Ä–º–∞ –ø–æ–¥–ø–∏—Å–∫–∏/–æ—Ç–ø–∏—Å–∫–∏ #}
    {% if request.user.is_authenticated and request.user.username != videopost.author.username %}
      <button
        type="button"
        class="btn btn-sm btn-outline-primary subscribe-button d-flex align-items-center"
        style="width: 150px; height: 32px !important;"
        data-username="{{ videopost.author.username }}"
      >
        <i class="fa-solid fa-bell me-1 text-warning"></i>
        {% if is_subscribed %}
          –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
        {% else %}
          –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
        {% endif %}
      </button>
    {% endif %}

  </div>


  <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ -->
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-sm btn-outline-primary like-btn" style="width: 60px; height: 32px !important;" data-slug="{{ videopost.slug }}">
      üëç <span class="like-count">{{ videopost.likes.count }}</span>
    </button>
    <button class="btn btn-sm btn-outline-danger dislike-btn" style="width: 60px; height: 32px !important;"" data-slug="{{ videopost.slug }}">
      üëé <span class="dislike-count">{{ videopost.dislikes.count }}</span>
    </button>
  </div>

  <!-- –î–∞—Ç–∞ -->
  <p class="date-text mb-0 text-muted small"><strong>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</strong> {{ videopost.publication_date|date:"d M Y H:i" }}</p>
</div>


  <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ -->
  <p>{{ videopost.description|linebreaks }}</p>

  <hr>





  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  {% if user == videopost.author %}
    <div class="d-flex gap-2 mt-3">
      <a href="{% url 'videopost:videopost_update' videopost.slug %}" class="btn btn-sm btn-warning">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <button class="btn btn-sm btn-danger" onclick="confirmDelete('{{ videopost.slug }}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  {% endif %}

  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ -->
  <div class="comments-section mt-5">
    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

    {% for comment in comments %}
      <div class="comment mb-3 p-3 border rounded">
        <strong>{{ comment.author.username|capfirst }}</strong> ‚Ä¢ <small class="text-muted">{{ comment.created_at|ru_timesince }}</small>
        <p>{{ comment.text }}</p>

        <!-- –û—Ç–≤–µ—Ç—ã -->
        <div class="replies ms-4">
          {% for reply in comment.replies.all %}
            <div class="reply mb-2 p-2 border rounded">
              <strong>{{ reply.author.username|capfirst }}</strong> ‚Ä¢ <small class="text-muted">{{ reply.created_at|ru_timesince }}</small>
              <p>{{ reply.text }}</p>
            </div>
          {% endfor %}
        </div>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'videopost:reply_comment' comment.id %}">
            {% csrf_token %}
            <input type="text" name="text" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..." class="form-control mt-2" required>
            <button type="submit" class="btn btn-sm btn-secondary mt-1">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          </form>
        {% endif %}
      </div>
    {% empty %}
      <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endfor %}
  </div>

  <h4>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</h4>
  {% if user.is_authenticated %}
    {% if user.is_banned %}
      <h2><strong>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–±–∞–Ω–µ–Ω!</strong></h2>
      <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.user.ban_reason }}</p>
      <p><strong>–°—Ä–æ–∫:</strong> {{ request.user.banned_until }}</p>
    {% else %}
      <div class="comment-box p-3">
        <form method="post" class="d-flex flex-column gap-2">
          {% csrf_token %}
          <input type="hidden" name="post_id" value="{{ videopost.id }}">
          <textarea name="text" class="form-control comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3" required></textarea>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-action flex-grow-1">–î–æ–±–∞–≤–∏—Ç—å</button>
            <a href="{% url 'videopost:videopost_list' %}" class="btn btn-action flex-grow-1">–ù–∞–∑–∞–¥</a>
          </div>
        </form>
      </div>
    {% endif %}
  {% else %}
    <p class="text-danger">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    <a href="{% url 'videopost:list' %}" class="btn btn-action mt-3">–ù–∞–∑–∞–¥</a>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  async function confirmDelete(slug) {
    const isConfirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–µ–æ–ø–æ—Å—Ç?");
    if (!isConfirmed) return;

    try {
      const response = await fetch(`/videopost/${slug}/archive/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await response.json();
      console.log("‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

      if (data.success) {
        alert("‚úÖ –í–∏–¥–µ–æ–ø–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!");
        window.location.href = "/videopost/";
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞.");
      }
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞.");
    }
  }

  function getCSRFToken() {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
      const trimmed = cookie.trim();
      if (trimmed.startsWith("csrftoken=")) {
        cookieValue = decodeURIComponent(trimmed.split("=")[1]);
      }
    });
    return cookieValue;
  }

  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const slug = button.getAttribute('data-slug');
      const action = button.classList.contains('like-btn') ? 'like' : 'dislike';

      try {
        const response = await fetch(`/videopost/${slug}/${action}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        const data = await response.json();

        if (data.success) {
          const container = button.parentElement;
          container.querySelector('.like-count').textContent = data.likes_count;
          container.querySelector('.dislike-count').textContent = data.dislikes_count;
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    });
  });
</script>

{% endblock %}
