<!-- videopost/templates/videopost/videopost_detail.html -->

{% extends 'base.html' %}
{% load youtube_tags %}
{% load time_filters %}

{% block title %}{{ videopost.title }}{% endblock %}

{% block content %}
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS Video.js –∏ —Ç–µ–º—ã -->
<link href="https://unpkg.com/video.js@8.10.0/dist/video-js.min.css" rel="stylesheet" />
<link href="https://unpkg.com/@videojs/themes@1.0.0/dist/city/index.css" rel="stylesheet" />

<div class="container mt-4">
  <h2>{{ videopost.title|default:"(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)" }}</h2>
  <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ videopost.created_at|ru_timesince }}</p>

  {% if videopost.video %}
    <!-- Video.js –ø–ª–µ–µ—Ä –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ -->
    <video
      id="my-video"
      class="video-js vjs-theme-city vjs-fluid rounded"
      controls
      preload="auto"
      playsinline
      data-setup='{
        "playbackRates": [0.5, 1, 1.25, 1.5, 2]
      }'
    >
      <source src="{{ videopost.video.url }}" type="video/mp4" />
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
    </video>

  {% elif videopost.video_file %}
    <!-- Video.js –ø–ª–µ–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -->
    <video
      id="my-video-Local"
      class="video-js vjs-theme-city vjs-fluid rounded"
      controls
      preload="auto"
      playsinline
      data-setup='{
        "playbackRates": [0.5, 1, 1.25, 1.5, 2]
      }'
    >
      <source src="{{ videopost.video_file.url }}" type="video/mp4" />
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
    </video>

  {% elif videopost.video_url|is_youtube_url %}
    <!-- YouTube –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π iframe -->
    <div class="video-container my-3">
      {{ videopost.video_url|embed_youtube|safe }}
    </div>

  {% elif videopost.video_url %}
    <!-- Fallback: iframe –±–µ–∑ YouTube -->
    <div class="ratio ratio-16x9">
      <iframe src="{{ videopost.video_url }}" title="–í–∏–¥–µ–æ" allowfullscreen></iframe>
    </div>

  {% else %}
    <p>–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.</p>
  {% endif %}
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS Video.js -->
<script src="https://unpkg.com/video.js@8.10.0/dist/video.min.js"></script>


<p class="empty-description"></p> <!-- –í—Å—Ç–∞–≤–∫–∞ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π –≤—ã—Å–æ—Ç–æ–π —á–µ—Ä–µ–∑ css -->


<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">


    <!-- –ê–≤—Ç–æ—Ä –∏ –ø–æ–¥–ø–∏—Å–∫–∞ -->
    <div class="d-flex align-items-center gap-2">
      <p class="author-text mb-0">
        –ê–≤—Ç–æ—Ä:
        <a href="{% url 'profile' username=videopost.author.username %}">
          {{ videopost.author.username|capfirst }}
        </a>
      </p>

      {% if request.user.is_authenticated and request.user.username != videopost.author.username %}
        <button
          type="button"
          class="btn btn-sm btn-outline-primary subscribe-button d-flex align-items-center"
          data-username="{{ videopost.author.username }}"
        >
          <i class="fa-solid fa-bell me-1 text-warning"></i>
          {% if is_subscribed %}
            –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
          {% else %}
            –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
          {% endif %}
        </button>
      {% endif %}
    </div>

    <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ -->
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-primary like-btn"
              style="width: 60px; height: 32px !important;"
              data-slug="{{ videopost.slug }}"
              title="–ù—Ä–∞–≤–∏—Ç—Å—è">
        üëç <span class="like-count">{{ videopost.likes.count }}</span>
      </button>
      <button class="btn btn-sm btn-outline-danger dislike-btn"
              style="width: 60px; height: 32px !important;"
              data-slug="{{ videopost.slug }}">
              title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
        üëé <span class="dislike-count">{{ videopost.dislikes.count }}</span>
      </button>
    </div>

    <!-- –î–∞—Ç–∞ -->
    <p class="date-text mb-0 text-muted small"><strong>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</strong> {{ videopost.publication_date|date:"d M Y H:i" }}</p>
  </div>

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ -->
  <p>{{ videopost.description|linebreaks }}</p>

  <hr>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  {% if user == videopost.author %}
    <div class="d-flex gap-2 mt-3">
      <a href="{% url 'videopost:videopost_update' videopost.slug %}" class="btn btn-sm btn-warning">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <button class="btn btn-sm btn-danger" onclick="confirmDelete('{{ videopost.slug }}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  {% endif %}

  <!-- –ó–¥–µ—Å—å –≤–º–æ–Ω—Ç–∏—Ä—É–µ–º –±–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ -->
  <div class="comments-section mt-5">
    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

    {% for comment in comments %}
      <div class="comment mb-3 p-3 border rounded">
        <strong>{{ comment.author.username|capfirst }}</strong> ‚Ä¢ <small class="text-muted">{{ comment.created_at|ru_timesince }}</small>
        <p>{{ comment.text }}</p>

        <!-- –û—Ç–≤–µ—Ç—ã -->
        <div class="replies ms-4">
          {% for reply in comment.replies.all %}
            <div class="reply mb-2 p-2 border rounded">
              <strong>{{ reply.author.username|capfirst }}</strong> ‚Ä¢ <small class="text-muted">{{ reply.created_at|ru_timesince }}</small>
              <p>{{ reply.text }}</p>
            </div>
          {% endfor %}
        </div>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'videopost:reply_comment' comment.id %}">
            {% csrf_token %}
            <input type="text" name="text" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..." class="form-control mt-2" required>
            <button type="submit" class="btn btn-sm btn-secondary mt-1">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          </form>
        {% endif %}
      </div>
    {% empty %}
      <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endfor %}
  </div>

  <h4>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</h4>
  {% if user.is_authenticated %}
    {% if user.is_banned %}
      <h2><strong>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–±–∞–Ω–µ–Ω!</strong></h2>
      <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.user.ban_reason }}</p>
      <p><strong>–°—Ä–æ–∫:</strong> {{ request.user.banned_until }}</p>
    {% else %}
      <div class="comment-box p-3">
        <form method="post" class="d-flex flex-column gap-2">
          {% csrf_token %}
          <input type="hidden" name="post_id" value="{{ videopost.id }}">
          <textarea name="text" class="form-control comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3" required></textarea>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-action flex-grow-1">–î–æ–±–∞–≤–∏—Ç—å</button>
            <a href="{% url 'videopost:videopost_list' %}" class="btn btn-action flex-grow-1">–ù–∞–∑–∞–¥</a>
          </div>
        </form>
      </div>
    {% endif %}
  {% else %}
    <p class="text-danger">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    <a href="{% url 'videopost:videopost_list' %}" class="btn btn-action mt-3">–ù–∞–∑–∞–¥</a>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞
  async function confirmDelete(slug) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const isConfirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–µ–æ–ø–æ—Å—Ç?");
    if (!isConfirmed) return;

    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞
      const response = await fetch(`/videopost/${slug}/archive/`, {
        method: "POST", // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST-–º–µ—Ç–æ–¥
        headers: {
          "X-CSRFToken": getCSRFToken(), // –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
          "X-Requested-With": "XMLHttpRequest", // –ü–æ–º–µ—Ç–∫–∞ AJAX-–∑–∞–ø—Ä–æ—Å–∞
        },
      });
      // –ü–∞—Ä—Å–∏–º JSON-–æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      const data = await response.json();
      console.log("‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data); // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

      if (data.success) {
        // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
        alert("‚úÖ –í–∏–¥–µ–æ–ø–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!");
        window.location.href = "/videopost/"; // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–æ–≤
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞."); // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
      }
    } catch (error) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞.");
    }
  }

  function getCSRFToken() {
    let cookieValue = null;
    // –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É cookie –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏
    document.cookie.split(";").forEach(cookie => {
      const trimmed = cookie.trim();   // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
      if (trimmed.startsWith("csrftoken=")) {
        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        cookieValue = decodeURIComponent(trimmed.split("=")[1]);
      }
    });
    return cookieValue;   // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ null
  }

  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏
    button.addEventListener('click', async () => {
      // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ—Å—Ç–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
      const slug = button.getAttribute('data-slug');
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ (like/dislike) –ø–æ –∫–ª–∞—Å—Å—É –∫–Ω–æ–ø–∫–∏
      const action = button.classList.contains('like-btn') ? 'like' : 'dislike';

      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch(`/videopost/${slug}/${action}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        // –ü–æ–ª—É—á–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        const data = await response.json();

        if (data.success) {
          // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–∫–∏
          const container = button.parentElement;
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
          container.querySelector('.like-count').textContent = data.likes_count;
          container.querySelector('.dislike-count').textContent = data.dislikes_count;
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); // –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ fetch-–∑–∞–ø—Ä–æ—Å–∞
      }
    });
  });
</script>

{% endblock %}
