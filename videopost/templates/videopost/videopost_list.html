{# videopost/templates/videopost/videopost_list.html #}
{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load time_filters %}

{% block title %}–í–∏–¥–µ–æ –ø–æ—Å—Ç—ã{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/videopost.css' %}">

<div class="container mt-5">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">–í–∏–¥–µ–æ –ø–æ—Å—Ç—ã</h2>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    {% if user.is_authenticated %}
      {% if user.is_banned %}
        <p><strong>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!</strong></p>
        <p><strong>–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–Ω–∞:</strong> {{ request.user.ban_reason }}</p>
        <p><strong>–°—Ä–æ–∫ –±–∞–Ω–Ω–∞ –¥–æ:</strong> {{ request.user.banned_until }}</p>
      {% else %}
        <a href="{% url 'videopost:videopost_create' %}" class="btn btn-success">üé• –ù–æ–≤—ã–π –≤–∏–¥–µ–æ–ø–æ—Å—Ç</a>
      {% endif %}
    {% endif %}
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ -->
  {% if videoposts %}
    {% include "include/paginator.html" with page=page_obj %}

    <div class="list-group">
      {% for video in videoposts %}
        <div id="video-{{ video.id }}" class="list-group-item py-3 d-flex gap-3 video-card">
          <!-- –ü—Ä–µ–≤—å—é –≤–∏–¥–µ–æ -->
          <div class="flex-shrink-0">
            {% if video.thumbnail %}
              <img
                src="{{ video.thumbnail.url }}"
                alt="–ü—Ä–µ–≤—å—é –≤–∏–¥–µ–æ"
                class="rounded"
                width="100" height="100"
                style="object-fit: cover; cursor: pointer;"
                onclick="openVideoModal('{{ video.video.url }}', '{{ video.title|escapejs }}')"
              >
            {% else %}
              <img
                src="{% static 'images/default_video.jpg' %}"
                alt="–ó–∞–≥–ª—É—à–∫–∞"
                class="rounded"
                width="100" height="100"
                style="object-fit: cover; cursor: pointer;"
                onclick="openVideoModal('{{ video.video.url }}', '{{ video.title|escapejs }}')"
              >
            {% endif %}
          </div>

          <div class="w-100">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <span
              class="h5 fw-bold text-decoration-none text-dark d-block"
              style="cursor: pointer;"
              onclick="openVideoModal('{{ video.video.url }}', '{{ video.title|escapejs }}')"
            >
              {{ video.title|default:"(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)" }}
            </span>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <p class="mb-2 text-muted small">{{ video.description|truncatewords:30 }}</p>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="d-flex justify-content-between text-muted small mt-2">
              <div class="d-flex gap-3 align-items-center">
                <span class="like-button" data-slug="{{ video.slug }}" title="–ù—Ä–∞–≤–∏—Ç—Å—è">
                  üëç <span class="like-count">{{ video.likes.count }}</span>
                </span>

                <span class="dislike-button" data-slug="{{ video.slug }}" title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
                  üëé <span class="dislike-count">{{ video.dislikes.count }}</span>
                </span>

                <a href="{% url 'videopost:videopost_detail' video.slug %}#comments" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">
                  <img src="{% static 'images/chat_18866235.png' %}" alt="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" width="16" height="16">
                </a>

                <span class="share-button" data-slug="{{ video.slug }}" data-bs-toggle="modal" data-bs-target="#shareModal" style="cursor: pointer;" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                  <img src="{% static 'images/share_8358780.png' %}" alt="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" width="16" height="16">
                </span>
              </div>

              <div class="video-meta text-muted small" style="font-size: 0.75rem;">
                {{ video.created_at|ru_timesince }} ‚Ä¢ {{ video.author.username|capfirst }}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {% include "include/paginator.html" with page=page_obj %}

  {% else %}
    <div class="alert alert-info mt-4" role="alert">–ü–æ–∫–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ –ø–æ—Å—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π!</div>
  {% endif %}
</div>

<!--  –û–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ -->

  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="videoPlayerModalLabel">–í–∏–¥–µ–æ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <video id="modalVideoPlayer" width="100%" controls preload="metadata">
          <source src="" type="video/mp4">
          –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
        </video>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {% if user.is_authenticated %}
    <script src="{% static 'js/likes.js' %}"></script>
  {% endif %}
  {% include 'videopost/share.html' %}

  <script>
function openVideoModal(videoUrl, videoTitle) {
  console.log("–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Å –≤–∏–¥–µ–æ:", videoUrl);
  const modal = new bootstrap.Modal(document.getElementById('videoPlayerModal'));
  const player = document.getElementById('modalVideoPlayer');
  const source = player.querySelector('source');
  const titleEl = document.getElementById('videoPlayerModalLabel');

  source.src = videoUrl;
  player.load();
  titleEl.textContent = videoTitle || '–í–∏–¥–µ–æ';

  modal.show();

  document.getElementById('videoPlayerModal').addEventListener('hidden.bs.modal', () => {
    player.pause();
    player.currentTime = 0;
    source.src = '';
    player.load();
  }, { once: true });
}

  </script>
{% endblock %}
