{% extends 'base.html' %}

{% block title %}–ü–æ—Å—Ç—ã{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">–°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤</h2>
    <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–æ–≤—ã–π –ø–æ—Å—Ç" —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    {% if user.is_authenticated %}
      <a href="{% url 'post_create' %}" class="btn btn-success">‚ûï –ù–æ–≤—ã–π –ø–æ—Å—Ç</a>
    {% endif %}
  </div>

  {% if posts %}
    <ul class="list-group">
      {% for post in posts %}
        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap" data-post-slug="{{ post.slug }}">

          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π slug -->
          {% if post.slug %}
            <a href="{% url 'post_detail' post.slug %}" class="fw-bold text-decoration-none text-dark">
              {{ post.title|default:"(–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)" }}
            </a>
          {% else %}
            <span class="text-danger">–ü–æ—Å—Ç –±–µ–∑ slug: {{ post.title|default:"(–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)" }}</span>
          {% endif %}

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å—Ç–µ -->
          <div class="text-muted small">
            –ê–≤—Ç–æ—Ä: {{ post.author.username }} ‚Ä¢ {{ post.created_at|date:"d.m.Y H:i" }}
          </div>

          <!-- –î–µ–π—Å—Ç–≤–∏—è: –õ–∞–π–∫, –¥–∏–∑–ª–∞–π–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞) -->
          <div class="mt-2 d-flex align-items-center gap-2">
            <button class="btn-like btn btn-sm btn-outline-primary" data-action="like">üëç</button>
            <span class="like-count">{{ post.likes.count }}</span>

            <button class="btn-dislike btn btn-sm btn-outline-danger" data-action="dislike">üëé</button>
            <span class="dislike-count">{{ post.dislikes.count }}</span>

            {% if user == post.author %}
              <a href="{% url 'post_update' post.slug %}" class="btn btn-sm btn-warning">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
              <a href="{% url 'post_delete' post.slug %}" class="btn btn-sm btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç -->
    <div class="alert alert-info mt-4" role="alert">
      –ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º (–¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å)
    </div>
  {% endif %}
</div>

<!-- JS –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.btn-like, .btn-dislike').forEach(button => {
    button.addEventListener('click', function () {
      const action = this.dataset.action;
      const container = this.closest('[data-post-slug]');
      const slug = container.dataset.postSlug;

      fetch(`/${slug}/${action}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        container.querySelector('.like-count').textContent = data.likes_count;
        container.querySelector('.dislike-count').textContent = data.dislikes_count;
      });
    });
  });

  // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
