{% extends 'base.html' %}

{% block title %}{{ post.title|default:"(Без заголовка)" }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mb-4">
    <h2>{{ post.title|default:"(Без заголовка)" }}</h2>
    <p class="text-muted">Автор: {{ post.author.username }} • {{ post.created_at|date:"d.m.Y H:i" }}</p>
    <p>{{ post.content }}</p>

    <!-- Блок лайков и дизлайков -->
    <div class="d-flex gap-3 align-items-center mt-3">
      <button id="like-button" class="btn btn-outline-warning">
        <span id="like-icon">
          {% if user in post.likes.all %}
            👍
          {% else %}
            <span style="color: white;">👍</span>
          {% endif %}
        </span>
        <span id="like-count">{{ post.likes.count }}</span>
      </button>

      <button id="dislike-button" class="btn btn-outline-secondary">
        <span id="dislike-icon">
          {% if user in post.dislikes.all %}
            👎
          {% else %}
            <span style="color: white;">👎</span>
          {% endif %}
        </span>
        <span id="dislike-count">{{ post.dislikes.count }}</span>
      </button>
    </div>
  </div>

  <!-- Комментарии -->
  <div class="mt-5">
    <h5>Комментарии</h5>
    {% for comment in post.comments.all %}
      <div class="border rounded p-3 mb-2">
        <strong>{{ comment.author.username }}</strong>
        <small class="text-muted">• {{ comment.created_at|date:"d.m.Y H:i" }}</small>
        <p class="mb-0">{{ comment.text }}</p>
      </div>
    {% empty %}
      <p class="text-muted">Комментариев пока нет.</p>
    {% endfor %}
  </div>

  <!-- Форма комментария -->
  {% if user.is_authenticated %}
    <div class="mt-4">
      <h6>Добавить комментарий</h6>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Отправить</button>
      </form>
    </div>
  {% else %}
    <p class="mt-4">Чтобы оставить комментарий, <a href="{% url 'login' %}">войдите в аккаунт</a>.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('like-button').addEventListener('click', function () {
    fetch("{% url 'like_post' post.slug %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data) {
        document.getElementById('like-count').textContent = data.likes_count;
        document.getElementById('like-icon').innerHTML = data.liked ? '👍' : '<span style="color: white;">👍</span>';
        document.getElementById('dislike-icon').innerHTML = '<span style="color: white;">👎</span>';
      }
    });
  });

  document.getElementById('dislike-button').addEventListener('click', function () {
    fetch("{% url 'dislike_post' post.slug %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data) {
        document.getElementById('dislike-count').textContent = data.dislikes_count;
        document.getElementById('dislike-icon').innerHTML = data.disliked ? '👎' : '<span style="color: white;">👎</span>';
        document.getElementById('like-icon').innerHTML = '<span style="color: white;">👍</span>';
      }
    });
  });
</script>
{% endblock %}
