<!DOCTYPE html>
<! --posts/templates/posts/post_detail.html -->

{% extends 'base.html' %}
{% load static %}  <!-- ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º static-—Ç–µ–≥–∏ -->
{% load time_filters %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}


  <div class="container mt-4">
<h2>{{ post.title|default:"(–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)" }}</h2>
    <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
    {% if post.image %}
      <img src="{{ post.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞" class="img-fluid my-3">
    {% endif %}

<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">

  <!-- –ê–≤—Ç–æ—Ä –∏ –ø–æ–¥–ø–∏—Å–∫–∞ -->
    <div class="d-flex align-items-center gap-2">
      <p class="author-text mb-0">
      –ê–≤—Ç–æ—Ä:
      <a href="{% url 'profile' username=post.author.username %}" class="text-decoration-none">
        {{ post.author.username|capfirst }}
      </a>
    </p>

       {% if request.user.is_authenticated and request.user.username != post.author.username %}
        <button
          type="button"
          class="btn btn-sm btn-outline-primary subscribe-button d-flex align-items-center"
          data-username="{{ post.author.username }}"
        >
          <i class="fa-solid fa-bell me-1 text-warning"></i>
          {% if is_subscribed %}
            –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
          {% else %}
            –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
          {% endif %}
        </button>
      {% endif %}
    </div>
        <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏ -->
        <div style="display: flex; justify-content: center; gap: 3mm;">
          <button class="btn btn-sm btn-outline-primary like-btn"
                  style="width: 60px; height: 32px !important;"
                  data-slug="{{ post.slug }}"
                  title="–ù—Ä–∞–≤–∏—Ç—Å—è">
            üëç <span class="like-count">{{ post.likes.count }}</span>
          </button>

          <button class="btn btn-sm btn-outline-danger dislike-btn"
                  style="width: 60px; height: 32px !important;"
                  data-slug="{{ post.slug }}"
                  title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
            üëé <span class="dislike-count">{{ post.dislikes.count }}</span>
          </button>
        </div>


    <!-- –î–∞—Ç–∞ -->
    <p class="date-text mb-0 text-muted small ms-2">
      <strong>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</strong> {{ post.publication_date|date:"d M Y H:i" }}
    </p>
  </div>

</div>

<p>{{ post.text|linebreaks }}</p>
<hr>


    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞) -->

   {% if user == post.author %}
       <div class="d-flex gap-2 mt-3">
        <a href="{% url 'posts:post_update' post.slug %}" class="btn btn-sm btn-warning">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <button class="btn btn-sm btn-danger" onclick="confirmDelete('{{ post.slug }}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
  </div>
{% endif %}

    <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
    <ul>
      {% for comment in post.comments.all %}
        <li><strong>{{ comment.author.username|capfirst }}</strong>: {{ comment.text }}</li>
      {% empty %}
        <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</li>
      {% endfor %}
    </ul>

 <h4>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</h4>
{% if user.is_authenticated %}
      {% if user.is_banned %}
            <h2><strong>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–±–∞–Ω–Ω–µ–Ω!</strong></h2>
            <p><strong>–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–Ω–∞:</strong> {{request.user.ban_reason}}</p>
            <p><strong>–°—Ä–æ–∫ –±–∞–Ω–Ω–∞:</strong> {{request.user.banned_until}}</p>

      {% else %}
<div class="comment-box p-3">
    <form method="post" class="d-flex flex-column gap-2">
        {% csrf_token %}
        <textarea name="text" class="form-control comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3"></textarea>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-action flex-grow-1">–î–æ–±–∞–≤–∏—Ç—å</button>
            <a href="{% url 'posts:post_list' %}" class="btn btn-action flex-grow-1">–ù–∞–∑–∞–¥</a>
        </div>
    </form>
</div>
      {% endif %}
{% else %}
    <p class="text-danger">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
    <a href="{% url 'posts:post_list' %}" class="btn btn-action mt-3">–ù–∞–∑–∞–¥</a>
{% endif %}
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'js/subscriptions.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script>

  async function confirmDelete(slug) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      const isConfirmed = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?");
    if (!isConfirmed) return;

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–∞
      const response = await fetch(`/posts/${slug}/archive/`, {
        method: "POST",   // –ò—Å–ø–æ–ª—å–∑—É–µ–º POST-–º–µ—Ç–æ–¥
        headers: {
          "X-CSRFToken": getCSRFToken(),            // –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
          "X-Requested-With": "XMLHttpRequest",     // –ü–æ–º–µ—Ç–∫–∞ AJAX-–∑–∞–ø—Ä–æ—Å–∞
        },
      });
       // –ü–∞—Ä—Å–∏–º JSON-–æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      const data = await response.json();
          console.log("‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);  // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

      if (data.success) {
          // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
        alert("‚úÖ –í–∞—à –ø–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!");

        // –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç –∏–∑ DOM
        const postElement = document.getElementById(`post-${slug}`);
        if (postElement) postElement.remove();

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤
        window.location.href = "/posts/";       // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ–ø–æ—Å—Ç–æ–≤
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞.");     // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
      }
    } catch (error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞.");
    }
  }

  function getCSRFToken() {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
      const trimmed = cookie.trim();
      if (trimmed.startsWith("csrftoken=")) {
        cookieValue = decodeURIComponent(trimmed.split("=")[1]);
      }

    });
    return cookieValue;
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".delete-btn").forEach(button => {
      if (!button.dataset.slug) return;
      button.addEventListener("click", () => confirmDelete(button.dataset.slug));
    });
  });
</script>
<script>
  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    button.addEventListener('click', async () => {
      const slug = button.getAttribute('data-slug');
      const action = button.classList.contains('like-btn') ? 'like' : 'dislike';

      try {
        const response = await fetch(`/posts/${slug}/${action}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        const data = await response.json();

        if (data.success) {
          const container = button.parentElement;
          container.querySelector('.like-count').textContent = data.likes_count;
          container.querySelector('.dislike-count').textContent = data.dislikes_count;
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
        }
      } catch (error) {
        alert('–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å');
      }
    });
  });

  function getCSRFToken() {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
      const trimmed = cookie.trim();
      if (trimmed.startsWith("csrftoken=")) {
        cookieValue = decodeURIComponent(trimmed.split("=")[1]);
      }
    });
    return cookieValue;
  }
</script>

{% endblock %}

